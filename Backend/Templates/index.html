<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Face Recognition System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #3498db;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            display: none;
            margin: 0 auto;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        #canvas-container {
            position: relative;
            display: inline-block;
        }
        canvas {
            max-width: 100%;
            border-radius: 8px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-8 font-sans">

    <div class="max-w-4xl mx-auto bg-white rounded-xl shadow-lg overflow-hidden">
        <div class="p-8">
            <h1 class="text-3xl font-bold text-center text-gray-800 mb-8">Face Recognition System</h1>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                
                <!-- Registration Section -->
                <div class="bg-blue-50 p-6 rounded-lg border border-blue-100">
                    <h2 class="text-xl font-semibold text-blue-800 mb-4">1. Add New User</h2>
                    <form id="registerForm" class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Name</label>
                            <input type="text" id="regName" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm p-2 border" placeholder="Enter full name" required>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700">Photo (Single Face)</label>
                            <input type="file" id="regPhoto" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100" required>
                        </div>
                        <button type="submit" class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition duration-200">Register User</button>
                    </form>
                    <div id="regStatus" class="mt-4 text-center font-medium"></div>
                </div>

                <!-- Recognition Section -->
                <div class="bg-green-50 p-6 rounded-lg border border-green-100">
                    <h2 class="text-xl font-semibold text-green-800 mb-4">2. Check/Verify Users</h2>
                    <p class="text-sm text-gray-600 mb-4">Upload a group photo or single selfie to identify registered users.</p>
                    <form id="recognizeForm" class="space-y-4">
                        <div>
                            <input type="file" id="recPhoto" accept="image/*" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-green-50 file:text-green-700 hover:file:bg-green-100" required>
                        </div>
                        <button type="submit" class="w-full bg-green-600 text-white py-2 px-4 rounded-md hover:bg-green-700 transition duration-200">Analyze Photo</button>
                    </form>
                    <div class="loader mt-4" id="recLoader"></div>
                </div>
            </div>

            <!-- Results Section -->
            <div id="resultsArea" class="mt-8 hidden">
                <h3 class="text-2xl font-bold text-gray-800 mb-4 border-b pb-2">Analysis Results</h3>
                
                <div class="flex flex-col items-center">
                    <div id="canvas-container">
                        <canvas id="resultCanvas"></canvas>
                    </div>
                    
                    <div id="namesList" class="mt-6 w-full max-w-lg space-y-2">
                        <!-- Recognized names will be injected here -->
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script>
        // Registration Logic
        document.getElementById('registerForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('regName').value;
            const file = document.getElementById('regPhoto').files[0];
            const statusDiv = document.getElementById('regStatus');

            statusDiv.innerHTML = '<span class="text-blue-600">Processing...</span>';

            const formData = new FormData();
            formData.append('name', name);
            formData.append('photo', file);

            try {
                const response = await fetch('/register', { method: 'POST', body: formData });
                const data = await response.json();
                
                if (data.success) {
                    statusDiv.innerHTML = `<span class="text-green-600">✅ ${data.message}</span>`;
                    document.getElementById('registerForm').reset();
                } else {
                    statusDiv.innerHTML = `<span class="text-red-600">❌ ${data.error}</span>`;
                }
            } catch (err) {
                statusDiv.innerHTML = '<span class="text-red-600">Server Error</span>';
            }
        });

        // Recognition Logic
        document.getElementById('recognizeForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const file = document.getElementById('recPhoto').files[0];
            const loader = document.getElementById('recLoader');
            const resultsArea = document.getElementById('resultsArea');
            const namesList = document.getElementById('namesList');
            
            loader.style.display = 'block';
            resultsArea.classList.add('hidden');
            namesList.innerHTML = '';

            const formData = new FormData();
            formData.append('photo', file);

            try {
                const response = await fetch('/recognize', { method: 'POST', body: formData });
                const data = await response.json();
                loader.style.display = 'none';

                if (data.success) {
                    resultsArea.classList.remove('hidden');
                    drawImageAndBoxes(data.image_url, data.matches);
                    displayList(data.matches);
                } else {
                    alert('Error: ' + data.error);
                }
            } catch (err) {
                loader.style.display = 'none';
                alert('Server connection error');
            }
        });

        function drawImageAndBoxes(imageUrl, matches) {
            const canvas = document.getElementById('resultCanvas');
            const ctx = canvas.getContext('2d');
            const img = new Image();
            
            img.onload = () => {
                // Set canvas dimensions to match image
                canvas.width = img.width;
                canvas.height = img.height;
                
                // Draw Image
                ctx.drawImage(img, 0, 0);

                // Draw Boxes
                matches.forEach(match => {
                    const box = match.box; // x, y, w, h
                    const isUnknown = match.name === "Unknown";
                    
                    ctx.lineWidth = 5;
                    ctx.strokeStyle = isUnknown ? 'red' : '#00ff00'; // Green for match, Red for unknown
                    ctx.strokeRect(box.x, box.y, box.w, box.h);

                    // Draw Text Background
                    ctx.fillStyle = isUnknown ? 'red' : '#00ff00';
                    const fontSize = Math.max(16, img.width / 40);
                    ctx.font = `bold ${fontSize}px Arial`;
                    const text = isUnknown ? "Unknown" : `${match.name} (${match.confidence}%)`;
                    const textWidth = ctx.measureText(text).width;
                    
                    ctx.fillRect(box.x, box.y - (fontSize + 10), textWidth + 10, fontSize + 10);
                    
                    // Draw Text
                    ctx.fillStyle = isUnknown ? 'white' : 'black';
                    ctx.fillText(text, box.x + 5, box.y - 10);
                });
            };
            img.src = imageUrl;
        }

        function displayList(matches) {
            const container = document.getElementById('namesList');
            if (matches.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500">No faces detected.</p>';
                return;
            }

            matches.forEach(match => {
                const isUnknown = match.name === "Unknown";
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg border flex justify-between items-center ${
                    isUnknown ? 'bg-red-50 border-red-200' : 'bg-green-50 border-green-200'
                }`;
                
                div.innerHTML = `
                    <span class="font-bold ${isUnknown ? 'text-red-700' : 'text-green-800'}">
                        ${match.name}
                    </span>
                    <span class="text-sm text-gray-600">
                        ${isUnknown ? 'Not in Database' : `Match: ${match.confidence}%`}
                    </span>
                `;
                container.appendChild(div);
            });
        }
    </script>
</body>
</html>
